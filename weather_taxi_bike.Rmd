---
title: "weather_taxi_bike"
author: "FC"
date: "12/10/2021"
output: html_document

---
## Visualization

```{r library}
library(knitr)
library(tidyverse)
library(dplyr)
library(tidyverse)
library(data.table)
library(patchwork)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r input data}
# Read velocity dataset.   
test_df <- read_csv("./data/test_dt_V1.csv")
test_df <- setDT(test_df)
test_df <- test_df[, date := format(as.Date(tpep_pickup_datetime),"%Y-%m-%d")]
test_df <- test_df[date >= "2020-06"][date < "2021-06"]

# Read weather dataset. 
weather_df <- read_csv("./data/manhattan_weather.csv")

# Data clean
test_df <- 
  test_df %>% 
  mutate(date = format(tpep_pickup_datetime, format = '%Y-%m-%d')) %>% 
  mutate(date = as.Date(date))
# Join table
weather_transport_df <-
  left_join(test_df, weather_df, by = "date") %>%
  dplyr::select(trip_distance, type, month, velocity, date, awnd, prcp, snwd, tmax, tmin, tsun) %>% 
  mutate(type = as.factor(type))

# Drawing plot
# Precipitation(mm) vs velocity
weather_transport_df_sp <-
  weather_transport_df %>% 
  drop_na(prcp, velocity) %>% 
  group_by(type, prcp) %>% 
  summarize(v_mean = mean(velocity))
# Draw plot with velocity and precipitation. 
ggplot(weather_transport_df_sp, aes(x = prcp, y = v_mean, group = type, colour = type)) + 
  geom_point(aes(colour = type)) +
  geom_smooth(method = lm) +
  labs(title = "Velocity vs Precipitation",
         x = "Precipitation/10 (mm)", 
         y = "Mean Velocity (m/s)") +
  theme(plot.title = element_text(hjust = 0.5))

# Precipitation(mm) vs transportation choice
weather_transport_df_pt <-
  weather_transport_df %>% 
  group_by(type, prcp, date) %>% 
  summarise(n_obs = n()) %>% 
  group_by(type, prcp) %>% 
  summarize(n_mean = mean(n_obs))
# Draw plot: precipitation vs transportation choice. 
ggplot(weather_transport_df_pt, aes(x = prcp, y = n_mean/sum(n_mean), group = type, colour = type)) + 
  geom_point(aes(color = type)) +
  geom_smooth(method = lm) +
  labs(title = "Transport Choice vs Precipitation", 
         x = "Precipitation/10 (mm)", 
         y = "Choice Possibility") +
  theme(plot.title = element_text(hjust = 0.5))

# popular of transportation vs month
weather_transport_df_tm <-
  weather_transport_df %>% 
  mutate(month = as.factor(month)) %>% 
  group_by(type, month) %>% 
  summarise(n_obs = n()) 

ggplot(weather_transport_df_tm, aes(x = month, y = n_obs, group = type, fill = type)) + 
  geom_bar(stat = "identity", alpha = 0.5) +
  geom_line(aes(color = type)) +
  facet_grid(.~type) +
  labs(title = "Popular of Transportation According to Month", 
         x = "Month", 
         y = "Trends of Transportation") +
  theme(plot.title = element_text(hjust = 0.5))

# High Temperature vs transportation choice. 
weather_transport_df_htn <-
  weather_transport_df %>% 
  mutate(month = as.factor(month)) %>% 
  group_by(type, tmax) %>% 
  summarise(n_obs = n()) 

ht_trans <- ggplot(weather_transport_df_htn, aes(x = tmax, y = n_obs, group = type, colour = type)) + 
  geom_point(aes(color = type)) +
  geom_smooth(se = FALSE) +
  labs(title = "Transit vs High T", 
         x = "High Temperature/10 (°C)", 
         y = "Trends of Transportation") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 7.5e+04))

# High Temperature vs velocity. 
weather_transport_df_htv <-
  weather_transport_df %>% 
  group_by(type, tmax) %>% 
  summarise(v_avg = mean(velocity)) 

ht_vel <- ggplot(weather_transport_df_htv, aes(x = tmax, y = v_avg, group = type, colour = type)) + 
  geom_point(aes(color = type)) +
  geom_smooth(se = FALSE) +
  labs(title = "High T vs Velocity", 
         x = "High Temperature/10 (°C)", 
         y = "Velocity (m/s)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(1, 7.5))

ht_trans + ht_vel

# Low Temperature vs transportation choice. 
weather_transport_df_ltn <-
  weather_transport_df %>% 
  group_by(type, tmin) %>% 
  summarise(n_obs = n()) 

lt_trans <- ggplot(weather_transport_df_ltn, aes(x = tmin, y = n_obs, group = type, colour = type)) + 
  geom_point(aes(color = type)) +
  geom_smooth(se = FALSE) +
  labs(title = "Transit vs Low T", 
         x = "Low Temperature/10 (°C)", 
         y = "Trends of Transportation") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(0, 9e+04))

# Low Temperature vs velocity. 
weather_transport_df_ltv <-
  weather_transport_df %>% 
  group_by(type, tmin) %>% 
  summarise(v_avg = mean(velocity)) 

lt_vel <- ggplot(weather_transport_df_ltv, aes(x = tmin, y = v_avg, group = type, colour = type)) + 
  geom_point(aes(color = type)) +
  geom_smooth(se = FALSE) +
  labs(title = "Velocity vs Low Temperature", 
         x = "Low Temperature/10 (°C)", 
         y = "Velocity (m/s)") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(limits = c(1, 8))

lt_trans + lt_vel
```

```{r linear regression}
# lm_velocity <-
#   weather_transport_df %>% 
#   sample_frac(0.0001) %>% 
#   filter(type == "bike") %>%
#   mutate(month = as.factor(month)) %>%
#   drop_na() %>% 
#   dplyr::select(-date) %>% 
#   as_tibble() %>% 
#   lm(velocity ~ trip_distance + month + awnd + prcp + snwd)
```
### Questions  
While we look into the dataset and explore the relation between all numbers, we hope to learn more about the characteristics through answering the following questions:  
- What might be the fastest transportation to choose within Manhattan?
- What is the most popular transportation people choose within a day?
- How would velocities of transports change according to time and borough differences?
- Is it worth commuting daily driving a car compared to using public transit regardless of the money?
- What is the distribution of public transit speed rates and how do they vary across the whole year? And what is the pattern of change during a day, a week, a season, or even the weather? sjz
- What is the geometric difference in choice making and distribution in various boroughs?
- What could we learn from the past year’s data and do they have any change related to COVID-19 pandemic?  
While we were manipulating and having deeper exploration, more useful insights, questions and conclusions came up. During this process, we organized and optimized the raw data, and transformed them into more readable explanations after appropriate processing. Meanwhile, we tried to discover and explain more based on existing data, find out the possible factors that might influence the speed, and combine them with the statistics analysis and map searching. 

### Velocity Heatmap  
**Velocity Heatmap**  
In addition to the data visualization described above, we also created an interactive map application using R Shiny, where we made a velocity heatmap with control widgets containing transport type and travel duration comparing their mean travel duration and mean velocity during different times of the day for each season. We aimed at providing a tool for people to estimate the travel time according to their travel plan and preference, for their convenience. 

制作过程描述  
To create this velocity heatmap, we first integrated the leaflet package to incorporate a worldwide map, drew polygons on Manhattan and divided the areas based on the taxi zone map. … 

具体功能描述   
Users are able to navigate through this velocity heatmap by selecting desired borough, vehicle type, month, day and time to compare the speed … By clicking the relative borough as our destination and pick up place, it helps to explore and predict the speed rate for each transit, and create interactive plots that respond to each mouse event, combined with R’s basic graphics functions. ... While using this app(热力图内容）, the users would be able to choose whatever the borough is within Manhattan using graphic straightforward clicking or synchronous web search for either pick up or drop off location. Pick up location and drop off place could be within the same borough. The time could be chosen as a detailed search information.other control widgets add? At each search, we will represent not only the estimated travel time for each public transportation, but also showing the velocity and (heat map). The date, time period, the transit way, …, would be shown below, and other information like weather, day time, season, type of the days will be shown and predicted. 

Some challenges arose during development using `R Shiny` and the `leaflet` package. We needed to divide the Manhattan region to different boroughs on the map and identified each click response with the corresponding area range. During which we came up and identified several problems and solved those difficulties as described below:

- Reducing dataset and identifying the information of boroughs specifically within Manhattan.   
There is a large dataset we downloaded from the website which includes all data within the NYC location. We targeted to reduce the size of the data and concentrated only on the Manhattan area. Among all the information, we first identified all borough names in NYC and filtered them only within Manhattan that we focused on and recorded them with the new numbers from 1 to 69.   

- Draw map and draw borough polygons according to borough division.   
Unlike worldwide maps that could be directly imported using `leaflet()`, the borough division on Manhattan should be further processed. We downloaded a Manhattan data(link) from the web and got their location data after data cleaning. `addPolygons()` function requires us to define the columns of latitude and longitude, which could be derived from our data, linking adjacent points using lines and creating shapes of interest.   
- What if the pick up location and drop off location are in the same borough?  
Regarding our original code, the same location could not be clicked twice which means if we double click the same borough and set it as both our origin and destination, the function would return `point_bool` parameter from `TRUE` to `FALSE` and lead to visualization error. To solve this problem, we used the `if` function to specify this special situation.   
- Merging problems while cooperating with branches.  
We have several branches while we are dealing with our codes, and all codes would be pushed to our personal branch first before finally merging into the main branch. As we have two people mainly dealing with the `Shiny` application, it required a lot of merging process and there were several times when code overlapped or merging problems on local paths arose. Solving this problem required constant updates between members.
- Click function?(km)  
- Host interactive R shiny application on Github over the web. (km)  
 
#### **Analysis and Summaries**  
Some major findings are worth pointing out from the velocity heatmap.   
***Taxi vs Bike***  
From the heat map, we found that the mean velocity of taking taxi is still faster compared to riding a bike overall. However, riding bikes during rush hour in Manhattan is competitive to take a taxi while only travelling across the nearby boroughs in Midtown. That means cabs will not save you more time when you only cycle between midtown but cost you more based on marketing price, especially for shorter trips. The usage of both bikes and cabs are of more need during daytime and become less after sunset which follow our travel habit. Moreover, people would be more likely to take a taxi to travel across more borough areas compared to riding bikes.   
***The Velocity of Borough***  
As we know the midtown of Manhattan is known for its bustling and busy traffic, the mean velocity in midtown is significantly slower compared to neighborhoods in Uppertown and Downtown. Moreover, the velocity in Uppertown and Randalls Island would be even quicker. And the specific traffic time would be more dependent on where you are coming from and where you are going to.   
What is worth emphasizing here is that the more boroughs that you cross, the faster velocity that we might obtain no matter where our pick up location is and what our transport is. We guess it might be because of the longer travel distance we have, the drivers or riders would more likely to choose the high way, the road with low traffic and avoid traffic lights.   

